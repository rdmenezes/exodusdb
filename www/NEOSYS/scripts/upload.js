// © 2007 NEOSYS Software Ltd. All Rights Reserved.//**Start Encode**

var gimageextensions=['gif','jpg','jpeg','png','tif','tiff','bmp']
var gvideoextensions=['mpg','mpeg','avi','mov','mp4','3gp']
var gaudioextensions=['mp3','wav','mid','midi']
var gdocumentextensions=['doc','xls','pdf','ppt','txt','zip']
var gaudiovisualextensions=[gimageextensions,gvideoextensions,gaudioextensions,gdocumentextensions].join(',').split(',')
var gexistingextensions=[]
var gvirtualroot

document.onkeydown=form_onkeydown

function form_onkeydown()
{
 if (window.event.keyCode==27) window.close()
}

function formfunctions_onload()
{
 loadimages()
 return true
}

function showuploadtable()
{
 table_upload.style.display='inline'
 form1.filedata.focus()
 button_showupload.style.display='none'
 audiovisualextensionselement.innerText='('+gaudiovisualextensions.join(',')+')'
}

function audiovisual_open()
{
 var imagen=event.srcElement.neosysimagen
 document.getElementById('audiovisuallink'+imagen).click()
}

function audiovisual_delete()
{
 
 var filename=event.srcElement.neosysfilename
 
 //confirm!
 if (!neosysyesno(filename+'\rAre you SURE that you want to delete this file permanently?\r\rNote: This is irreversible!',2)) return neosysinvalid()
 
 db.request='EXECUTE\r\GENERAL\r\DELETEUPLOAD\r'+filename
 if (!db.send()) return neosysinvalid(db.response)
 loadimages()
 
}

function upload_onclick()
{

 //check file to upload entered
 var sourcefilename=form1.filedata.value
 if (!sourcefilename) return neosysinvalid('Please browse for a file name to upload first')

 //split off the actual file name
 var sourcefilename=sourcefilename.split('/').slice(-1)[0].split('\\').slice(-1)[0]
 var extension=form1.filedata.value.split('.').slice(-1)[0].toLowerCase()

 //check file extensions
 if (!gaudiovisualextensions.neosyslocate(extension))
 {
  return neosysinvalid('Files ending .'+extension+' are not allowed to be uploaded\r\rThe allowed file extensions are:\r\r'+gaudiovisualextensions.join(', '))
 }

 var mode=(gexistingextensions.neosyslocate(extension))?'UPDATE':'CREATE'
 if (gparameters.versionno)
 {
  var targetfilename=gparameters.originalkeyversionno+'.'+sourcefilename
 }
 else
 {
  var targetfilename=gparameters.originalkeyversionno+'.'+extension
 }
 var question='Uploading '+sourcefilename+' -> '+targetfilename+'\r\r'

 //confirm update
 if (mode=='UPDATE')
 {
  if (!neosysyesno(question+'Are you SURE that you want to overwrite the existing file permanently?\rThis action cannot be undone!',2)) return neosysinvalid()
 }
 else
 {
  //if (!neosysokcancel(question+'\rOK to upload this file now?',1)) return neosysinvalid()
 }
 
 //ensure folders are made because upload may not be able to make them
 db.request='EXECUTE\rGENERAL\r\MAKEUPLOADPATH\r'+gparameters.originalkeyversionno
 if (!db.send()) return neosysinvalid(db.response)
 
 //check allowed to update/create
 //if (!neosyssecurity('MATERIAL '+mode)) return neosysinvalid(gmsg)
 
 //set the target filename
 form1.filename.value=targetfilename
 
 //set the path
 temp=document.location.pathname.toString().split('/')
 //remove the upload.htm and anything following
 temp=temp.slice(0,-1)
 //temp[temp.length-1]='images'
 var virtualroot=gvirtualroot
 if (gvirtualroot.slice(0,3)=='../')
 {
  virtualroot=gvirtualroot.slice(3)
  temp=temp.slice(0,-1)
 }
 temp[temp.length]=virtualroot
 //form1.pathdata.value="/neosys/images"
 form1.pathdata.value='/'+temp.join('/')
 if (form1.pathdata.value.slice(-1)=='/') form1.pathdata.value=form1.pathdata.value.slice(0,-1)

 //set the custom response URL otherwise default response page is generated by the upload program
 //this is a kind of debugging page
 form1.redirectpage.value='../upload2.htm?sourcefilename='+sourcefilename+'&targetpath='+form1.pathdata.value
 
 return true
 
}

function loadimages()
{
 
 //clear existing images
 images.innerHTML=''
 
 //display the primary key and versionno
 //it may be overiden below if the key uses the same versionno as a previous key
 //if changed also change VERIFYUPLOAD in UPLOAD.SUBS unless verify can be moved/implemented here from general_add_archive somehow
 //gparameters.originalkeyversionno=gparameters.database+'\\UPLOAD\\'+gparameters.filename+'\\'+gparameters.key+'\\'+gparameters.key+'.'+gparameters.versionno
 //gparameters.originalkeyversionno=gparameters.database+'\\UPLOAD\\'+gparameters.filename+'\\'+gparameters.key+'\\'+gparameters.versionno
 var uploadtarget=''
 if (gparameters.database) uploadtarget+=gparameters.database+'\\UPLOAD\\'
 if (gparameters.filename) uploadtarget+=gparameters.filename+'\\'
 uploadtarget+=gparameters.key
 if (gparameters.versionno) uploadtarget+='\\'+gparameters.versionno
 
 gparameters.originalkeyversionno=uploadtarget
 
 form1.submit.value='Upload '+gparameters.originalkeyversionno
 
 //return openwindow('EXECUTE\r\GENERAL\r\OPENUPLOAD',key+'.'+versionno)
 
 gexistingextensions=[]
  
 db.request='EXECUTE\r\GENERAL\r\OPENUPLOAD\r'+gparameters.originalkeyversionno
 if (!db.send()) return neosysinvalid(db.response)

 var imagedata=(fm+db.data).split(fm)
  
 gvirtualroot=imagedata[1]

 //no images so show upload form
 if (!imagedata[2])
 {
  showuploadtable()
  return true
 }

 //update may be allowed 
 if (gparameters.updateallowed) button_showupload.style.display='inline'
 
 //load image(s) into the page
 var imageURLs=imagedata[2].split(vm)
 for (imagen=0;imagen<imageURLs.length;imagen++)
 {
  
  //rule
  images.insertBefore(document.createElement('HR'))
   
  var filename=imageURLs[imagen]
  //var filename=imageURLs[imagen].split('/').slice(-1)[0]
  //var filename=filename.split('\\').slice(-1)[0]
   
  var fileextension=imageURLs[imagen].split('.').slice(-1)[0]
  gexistingextensions[gexistingextensions.length]=fileextension
   
  //show a link
  
  var link=document.createElement('A')
  link.href=gvirtualroot+imageURLs[imagen]
  link.innerText=filename
  link.id='audiovisuallink'+imagen
  images.insertBefore(link)
    
  //spacer
  var span=document.createElement('SPAN')
  span.innerHTML='&nbsp;&nbsp;'
  images.insertBefore(span)

  //and an Open button
  var button=document.createElement('BUTTON')
  button.value='Open'
  images.insertBefore(button)
  button.onclick=audiovisual_open
  button.neosysimagen=imagen
    
  //delete may be allowed
  if (gparameters.deleteallowed) adddeletebutton(filename)
    
  //image
  if (gimageextensions.neosyslocate(fileextension))
  {
 
   //br
   var br=document.createElement('BR')
   images.insertBefore(br)

   //show image
   var img=document.createElement('IMG')
   img.src=gvirtualroot+imageURLs[imagen]
   images.insertBefore(img)
 
  }
  
 }
 
 //rule
 images.insertBefore(document.createElement('HR'))
   
 //P
 images.insertBefore(document.createElement('P')).innerHTML='&nbsp;'
    
 return true
 
}

function adddeletebutton(filename)
{

 //add a delete button
 if (neosyssecurity('UPLOAD DELETE'))
 {
  var button=document.createElement('BUTTON')
  button.value='Delete'
  images.insertBefore(button)
  button.neosysfilename=filename
  button.onclick=audiovisual_delete
 }
}

function postupload()
{
 if (gparameters.versionno) window.close()
 else loadimages()
}
